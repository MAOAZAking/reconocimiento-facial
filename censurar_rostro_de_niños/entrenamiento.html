<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Entrenamiento de Reconocimiento</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #container { max-width: 800px; text-align: center; }
        #imageContainer { position: relative; margin-top: 20px; min-height: 200px; border: 2px dashed #ccc; }
        #imageContainer img, #imageContainer canvas { max-width: 100%; height: auto; }
        #imageContainer canvas { position: absolute; top: 0; left: 0; }
        #status { margin: 15px 0; font-weight: bold; font-size: 1.2em; }
        #controls button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 5px; }
        #modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        #modal-content { background-color: #fefefe; margin: auto; padding: 20px; border: 1px solid #888; width: 80%; max-width: 400px; text-align: center; }
        #face-preview { max-width: 150px; height: auto; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div id="container">
        <h1>Fase 1: Entrenamiento Interactivo</h1>
        <p>Sube una foto de la carpeta <strong>fotos_limpias</strong>. El sistema detectará los rostros y te pedirá que los clasifiques.</p>
        <div id="controls">
            <input type="file" id="imageUpload" accept="image/*" style="display: none;">
            <button onclick="document.getElementById('imageUpload').click()">Cargar Foto para Entrenar</button>
            <button id="saveButton" disabled>Guardar Conocimiento (JSON)</button>
        </div>
        <div id="status">Cargando modelos de IA...</div>
        <div id="imageContainer">
            <img id="imagePreview" />
            <canvas id="canvas"></canvas>
        </div>
    </div>

    <!-- Modal para etiquetar -->
    <div id="modal">
        <div id="modal-content">
            <h2>¿Qué rostro es este?</h2>
            <canvas id="face-preview"></canvas>
            <p>Por favor, clasifica el rostro.</p>
            <button id="btn-nino">Niño</button>
            <button id="btn-adulto">Adulto</button>
            <button id="btn-ignorar">Ignorar</button>
        </div>
    </div>

    <script>
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const imageContainer = document.getElementById('imageContainer');
        const canvas = document.getElementById('canvas');
        const statusEl = document.getElementById('status');
        const saveButton = document.getElementById('saveButton');
        const modal = document.getElementById('modal');
        const facePreview = document.getElementById('face-preview');

        const MODEL_URL = './models';
        let labeledDescriptors = [];

        async function loadModels() {
            try {
                await Promise.all([
                    faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                    faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                    faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                ]);
                statusEl.innerText = 'Modelos cargados. Por favor, carga una imagen.';
            } catch (error) {
                console.error(error);
                statusEl.innerText = 'Error al cargar los modelos.';
            }
        }
        loadModels();

        imageUpload.addEventListener('change', async () => {
            if (imageUpload.files.length === 0) return;
            const file = imageUpload.files[0];
            const imageUrl = URL.createObjectURL(file);

            imagePreview.src = imageUrl;
            imagePreview.onload = async () => {
                URL.revokeObjectURL(imagePreview.src);
                statusEl.innerText = 'Detectando rostros...';

                const detections = await faceapi.detectAllFaces(imagePreview)
                    .withFaceLandmarks()
                    .withFaceDescriptors();

                if (detections.length === 0) {
                    statusEl.innerText = 'No se encontraron rostros. Prueba con otra imagen.';
                    return;
                }

                statusEl.innerText = `Se encontraron ${detections.length} rostro(s). Clasificando...`;
                faceapi.matchDimensions(canvas, imagePreview);
                const resizedDetections = faceapi.resizeResults(detections, imagePreview);
                faceapi.draw.drawDetections(canvas, resizedDetections);

                for (let i = 0; i < detections.length; i++) {
                    const detection = detections[i];
                    const label = await askForLabel(detection.detection.box);
                    if (label) { // 'niño' o 'adulto'
                        labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(label, [detection.descriptor]));
                        const drawBox = new faceapi.draw.DrawBox(detection.detection.box, { label });
                        drawBox.draw(canvas);
                    }
                }

                statusEl.innerText = `Etiquetado completo. Total de rostros en memoria: ${labeledDescriptors.length}. Carga otra foto o guarda el conocimiento.`;
                if (labeledDescriptors.length > 0) {
                    saveButton.disabled = false;
                }
            };
        });

        function askForLabel(box) {
            return new Promise(resolve => {
                // Extraer el rostro a un canvas preview
                const faceCanvas = facePreview;
                const faceCtx = faceCanvas.getContext('2d');
                const { x, y, width, height } = box;
                faceCanvas.width = width;
                faceCanvas.height = height;
                faceCtx.drawImage(imagePreview, x, y, width, height, 0, 0, width, height);

                modal.style.display = 'flex';

                document.getElementById('btn-nino').onclick = () => { modal.style.display = 'none'; resolve('niño'); };
                document.getElementById('btn-adulto').onclick = () => { modal.style.display = 'none'; resolve('adulto'); };
                document.getElementById('btn-ignorar').onclick = () => { modal.style.display = 'none'; resolve(null); };
            });
        }

        saveButton.addEventListener('click', () => {
            if (labeledDescriptors.length === 0) {
                alert('No hay rostros etiquetados para guardar.');
                return;
            }
            // Simplificamos la estructura para el JSON
            const dataToSave = labeledDescriptors.map(ld => ({
                label: ld.label,
                descriptors: ld.descriptors.map(d => Array.from(d)) // Convertir Float32Array a Array normal
            }));

            const jsonString = JSON.stringify(dataToSave);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = 'conocimiento_facial.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            statusEl.innerText = 'Conocimiento guardado en "conocimiento_facial.json".';
        });
    </script>
</body>
</html>