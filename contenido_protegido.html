<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contenido Protegido</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin: 0; background-color: #333; color: white; }
        #videoContainer {
            position: relative;
            width: 720px;
            height: 560px;
            margin-top: 20px;
            border: 3px solid white;
            border-radius: 10px;
            overflow: hidden;
            transition: all 0.5s ease-in-out;
        }
        video, canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        #status { margin-top: 15px; font-size: 24px; font-weight: bold; height: 40px; }
        #protectedContent {
            display: none;
            margin-top: 30px;
            padding: 40px;
            border: 2px dashed #4CAF50;
            background-color: #444;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }

        /* --- Estilos para la vista desbloqueada --- */
        body.unlocked > h1,
        body.unlocked > p {
            display: none;
        }
        body.unlocked #videoContainer {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 240px;
            height: 180px;
            z-index: 100;
            margin-top: 0;
        }
        body.unlocked #protectedContent {
            display: block;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <h1>Paso 2: Desbloqueo de Contenido</h1>
    <p>Mira a la cámara. Si tu rostro es el autorizado, el contenido aparecerá.</p>
    <div id="status">Cargando...</div>
    <div id="videoContainer">
        <video id="video" width="720" height="560" autoplay muted playsinline></video>
        <canvas id="canvas"></canvas>
    </div>

    <div id="protectedContent">
        <h2>¡Acceso Concedido!</h2>
        <p>Este es el contenido secreto que solo tú puedes ver.</p>
        <img src="https://via.placeholder.com/400x200.png?text=Contenido+Secreto" alt="Contenido Secreto">
    </div>

    <script>
        const video = document.getElementById('video');
        const statusEl = document.getElementById('status');
        const protectedContent = document.getElementById('protectedContent');
        const bodyEl = document.body;
        const MODEL_URL = './models';
        let faceMatcher = null;

        async function start() {
            const authorizedFaceJSON = sessionStorage.getItem('authorizedFace');
            if (!authorizedFaceJSON) {
                statusEl.innerText = "No hay rostro registrado. Redirigiendo...";
                setTimeout(() => window.location.href = 'registro_facial.html', 2000);
                return;
            }
            const authorizedDescriptor = new Float32Array(Object.values(JSON.parse(authorizedFaceJSON)));

            statusEl.innerText = "Cargando modelos de IA...";
            await Promise.all([
                faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
            ]);
            
            const labeledFaceDescriptors = [new faceapi.LabeledFaceDescriptors('authorized', [authorizedDescriptor])];
            faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.5);

            statusEl.innerText = "Iniciando cámara...";
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: {} });
                video.srcObject = stream;
            } catch (err) {
                console.error(err);
                statusEl.innerText = "Error al acceder a la cámara.";
            }
        }

        video.addEventListener('play', () => {
            const canvas = faceapi.createCanvasFromMedia(video);
            document.getElementById('videoContainer').append(canvas);

            statusEl.innerText = "Escaneando rostro...";

            setInterval(async () => {
                const displaySize = { width: video.clientWidth, height: video.clientHeight };
                faceapi.matchDimensions(canvas, displaySize);

                const detections = await faceapi.detectAllFaces(video).withFaceLandmarks().withFaceDescriptors();
                const resizedDetections = faceapi.resizeResults(detections, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                
                let isAuthorized = false;
                if (detections.length > 0 && faceMatcher) {
                    const results = resizedDetections.map(d => faceMatcher.findBestMatch(d.descriptor));
                    results.forEach((result, i) => {
                        if (result.label === 'authorized') {
                            isAuthorized = true;
                        }
                    });
                }

                if (isAuthorized) {
                    bodyEl.classList.add('unlocked');
                    statusEl.innerText = "Acceso Concedido";
                    document.getElementById('videoContainer').style.borderColor = '#4CAF50';
                } else {
                    bodyEl.classList.remove('unlocked');
                    statusEl.innerText = detections.length > 0 ? "Acceso Denegado" : "Buscando un rostro...";
                    document.getElementById('videoContainer').style.borderColor = detections.length > 0 ? '#f44336' : 'white';
                }
            }, 300);
        });

        start();
    </script>
</body>
</html>